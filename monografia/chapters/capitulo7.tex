\chapter{Estrutura de implementação do simulador}
\label{cap7}

Neste capítulo, será descrito as ferramentas de suporte utilizadas na construção do simulador.

\section{\textit{Game Engine}}
\label{cap7.1}

A \textit{engine} utilizada neste jogo foi a \textit{Box2D}.Seu manual pode ser encontrado em~[\citenum{Box2Dmanual}]. A principal funcionalidade da \textit{Box2D} neste jogo foi auxiliar na criação dos objetos e no tratamento de eventos relacionados a simulação das leis da física. Estes eventos estão apresentados abaixo:

\begin{itemize}
	\item Gravidade
	\item Colisão
	\item Força de ação e reação
	\item Força de atrito
	\item Força de fricção
\end{itemize}

Além dessas funcionalidades, a \textit{Box2D} é responsável pela gerência de memória, junção de objetos e/ou fixação deles.

\section{\textit{Bibliotecas de apoio}}
\label{cap7.2}

Para facilitar a implementação de foram utilizadas diversas bibliotecas. Uma das bibliotecas padrão do C++ a STL \textit{(Standart Template Library)} possui algumas estruturas complexas de dados já implementadas, sendo amplamente utilizada neste simulador. Para a parte gráfica do jogo foi utilizada a biblioteca SDL \textit{(Simple Direct Layer)} conjuntamente com a \textit{OpenGL} (\textit{Open Graphics Library}). Com relação ao áudio, utilizou-se a SDL\_mixer. Para tratamento de \textit{input} foi utilizada a \textit{Touchlib}.

\subsection{SDL e \textit{OpenGL}}
\label{cap7.2.1}

Por oferecer uma boa abstração de \textit{hardware}, ser bem difundida no mercado de jogos e possuir ampla documentação, utilizou-se a SDL para disponibilizar o acesso ao ambiente \textit{OpenGL}. Conjuntamente com a SDL, na parte gráfica, foi utilizado a \textit{OpenGL} (\textit{Open Graphics Library}) que realiza a renderização das imagens.

A SDL\_mixer é utilizada para permitir a reprodução de diversas faixas de audio simultaneamente.

\subsection{Protocolo \textit{TUIO}}
\label{cap7.2.2}

Comunicação entre o usuário da mesa com o aplicativo é realizada de acordo com o protocolo \textit{TUIO}~[\citenum{TUIO}] (\textit{Tangible User Interface System}). Este protocolo especificado para atender as necessidades da comunicação das interfaces tangíveis. Interfaces tangíveis são interfaces sensíveis a toque, capazes de serem controladas por movimentos corporais e gestos. A implementação é simples e visa melhorar a performace na comunicação. Para isso, ele opera sobre a camada UDP(\textit{User Datagram Protocol}) de transporte utilizando três tipos de mensagens: \textit{set}, \textit{alive} e \textit{fseq}. Mensagens \textit{set} são utilizadas para informar o estado de um objeto. Mensagens \textit{alive} indicam o conjunto de objetos presentes na interface através de uma identificação única atribuída a cada novo elemento reconhecido. Mensagens \textit{fseq} são transmitidas antes da etapa de atualização de cada quadro para marcar-lo unicamente, associando-o a cada mensagem \textit{set} e \textit{alive} dele. Resumindo o funcionamento do protocolo:

\begin{itemize}
	\item Parâmetros do objeto são enviados após mudança de estado através da mensagem \textit{set}
	\item Objetos removidos da interface são comunicados através de mensagens \textit{alive}
	\item Cliente deduz a lista de objetos adicionados e removido por meio das mensagens \textit{set} e \textit{alive}
	\item Mensagens \textit{fseq} associam um ID a um conjunto de mensagens \textit{set} e \textit{alive} do quadro
\end{itemize}

Apesar da camada UDP de transporte não oferecer garantia de entrega dos dados, o TUIO implementa redundância de informação para se precaver contra a perda de dados na transmissão. Além disso, o estado de um objeto, mesmo inalterado, é enviado periodicamente em uma mensagem \textit{set}. Portanto, o protocolo é ideal para ser utilizado em aplicativos controlados interfaces multitoques otimizando a iteração e confiabilidade da comunicação.

\textbf{\large{Parâmetros das mensagens TUIO}}

\begin{table}[htbp]
  \centering
    \begin{tabular}{|l|l|l|} %rrr}
    \textbf{Parametros} & \textbf{Significado dos parametros} & \textbf{Tipo} \\
    s     & sessionID (ID temporário do objeto) & int32 \\
    x, y  & posição & float32 \\
    X, Y  & vetor de movimento (velocidade de movimento e direção) & float32 \\
    m     & aceleração de movimento & float32 \\
    w, h  & largura e altura do \textit{blob} & float32 \\
    \end{tabular}%
		\caption{Parâmetros de mensagens TUIO em superfícies interativas 2D}
  \label{tab:tabela1_param_TUIO}%
\end{table}%

\subsection{\textit{Touchlib}}
\label{cap7.2.3}

\textit{Touchlib}~[\citenum{Touchlib}] é uma biblioteca para auxiliar o processamento de imagens capturadas pela webcam em iterações com superfícies multitoque. Ela lida com o acompanhamento de \textit{blobs} de luz infravermelha, e envia para seus programas esses eventos multitoques, como o encostar do dedo, deslocamento do dedo e o retirar do dedo. Inclui um aplicativo de configuração, algumas demos para exemplificar seu uso. Interage com a maioria dos tipos de webcams e os dispositivos de captura de vídeo sendo muito útil para um projeto de \textit{software} para mesa multitoque. Em contrapartida só tem suporte para para sistema operacional \textit{Windows}.

Seu funcionamento consiste na aplicação de filtros de forma customizável como os mostrados nesta figura~[\ref{filtros}]. A execução destes filtros são realizadas pela \textit{Touchlib} com o uso da \textit{OpenCV (Open Source Computer Vision Library)}, uma biblioteca para o desenvolvimento de aplicativos de processamento de imagens. A execução da \textit{Touchlib} funciona de acordo com o paradigma cliente-servidor, sendo a mesma atuando como servidor e a aplicação como cliente. Esta comunicação cliente-servidor é feita utilizando o protocolo TUIO~[\citenum{TUIO}] \textit{(Tangible User Interface System)}, permitindo uma arquitetura distribuída, onde o aplicativo é executado separadamente da aplicação do processamento de imagens.
